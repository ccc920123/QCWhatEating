"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function loader(e,r){var t=e;t.cacheable&&t.cacheable();var a=_loaderUtils2.default.parseQuery(t.resourceQuery),p=t.resourcePath,s=(_path2.default.relative(".",p),a.uxType),i=a.name||(0,_utils.getNameByPath)(p);_validator2.default.isReservedTag(i)&&(0,_utils.logWarn)(t,[{reason:"脚本文件名不能使用保留字:"+i}]),(0,_utils.print)({resourceQuery:t.resourceQuery,resourcePath:t.resourcePath,name:i});var o=(0,_compiler.parseFragmentsWithCache)(r,p);return(0,_utils.print)(o),parseImportList(t,o.import).then(function(){return assemble(t,o,i,s,p)})}function parseImportList(e,r){return Promise.all(r.map(function(r){return resolveImportItemSrc(e,r)}))}function resolveImportItemSrc(e,r){return r.attrs.src?new Promise(function(t){e.resolve(e.context,r.attrs.src,function(e,a){return e?(r.isValid=!1,r.err=e,t(r)):(r.isValid=!0,r.srcPath=a,t(r))})}):(r.isValid=!1,Promise.resolve(r))}function assemble(e,r,t,a,p){var s="";if(a===_utils.UX_TYPE.APP){s+=(0,_uxFragmentUtils.processScriptFrag)(e,r.script,a),s+="\n$app_define$('@app-application/"+t+"', [], function($app_require$, $app_exports$, $app_module$){\n",r.script.length>0&&(s+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",s+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),s+="})\n";s+="\n$app_bootstrap$('@app-application/"+t+"',{ packagerVersion: '"+JSON.parse(_fs2.default.readFileSync(packagepath).toString()).subversion.packager+"'})\n"}else{var i=[];if(s+=(0,_uxFragmentUtils.processImportFrag)(e,r.import,i),s+=(0,_uxFragmentUtils.processTemplateFrag)(e,r.template,a),s+=(0,_uxFragmentUtils.processStyleFrag)(e,r.style,a),s+=(0,_uxFragmentUtils.processScriptFrag)(e,r.script,a),s+="\n$app_define$('@app-component/"+t+"', [], function($app_require$, $app_exports$, $app_module$){\n",r.script.length>0&&(s+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",s+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),s+="     $app_module$.exports.template = $app_template$\n",r.style.length>0&&(s+="     $app_module$.exports.style = $app_style$\n"),s+="})\n",(0,_utils.isUXRender)(a)){s+="\n$app_bootstrap$('@app-component/"+t+"',{ packagerVersion: '"+JSON.parse(_fs2.default.readFileSync(packagepath).toString()).subversion.packager+"'})\n"}}return s}var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_md=require("md5"),_md2=_interopRequireDefault(_md),_path=require("path"),_path2=_interopRequireDefault(_path),_loaderUtils=require("loader-utils"),_loaderUtils2=_interopRequireDefault(_loaderUtils),_validator=require("../../compiler/template/validator"),_validator2=_interopRequireDefault(_validator),_uxFragmentUtils=require("./ux-fragment-utils"),_compiler=require("../../compiler"),_utils=require("../../common/utils"),loaderPath=__dirname,packagepath=_path2.default.resolve(loaderPath,"../../package.json");module.exports=loader;