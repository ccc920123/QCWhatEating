"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _slicedToArray=function(){function e(e,t){var n=[],s=!0,i=!1,o=void 0;try{for(var r,a=e[Symbol.iterator]();!(s=(r=a.next()).done)&&(n.push(r.value),!t||n.length!==t);s=!0);}catch(e){i=!0,o=e}finally{try{!s&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_loaderUtils=require("loader-utils"),_loaderUtils2=_interopRequireDefault(_loaderUtils),_compiler=require("../../compiler"),_info=require("../../common/info"),_utils=require("../../common/utils");module.exports=function(e,t){var n=this;this.cacheable&&this.cacheable();var s=this.async(),i=_loaderUtils2.default.parseQuery(this.query),o=_loaderUtils2.default.parseQuery(this.resourceQuery)||{},r=i.type,a=o.uxType,l=this.resourcePath,u=i.index;null!=u&&u.match(/^\d+$/)&&(u=parseInt(u)),Promise.resolve((0,_compiler.parseFragmentsWithCache)(e,l)[r]).then(function(s){null!=u&&(s=s[u]);var i=s.content.trim();if(r===_utils.FRAG_TYPE.SCRIPT&&(0,_utils.isUXEntry)(a)&&"Y"===process.env.NODE_TEST)if(l.match(/src\/app\./))i="import '../node_modules/"+_info.moduleName+"/tools/packager/common/app.js'\n "+i;else{var o=l.replace("/src/","/test/").replace(/\.\w{2,5}$/,".js");if(_fs2.default.existsSync(o)){var c=o.match(/\/test\/(.*)/)[1];i="\nimport fnTestCase from '"+c+"'\n"+i,i=i.replace("export default {","export default {\n    onCreate () {\n      // 允许back被外部覆盖\n      if (this._options._descriptor) {\n        this._options._descriptor['back'] = {access: 'public'}\n      }\n\n      // 测试执行：开始时间，结束事件\n      global.CASE_TEST_START = global.CASE_TEST_START || 1000\n      global.CASE_TEST_TIMEOUT = global.CASE_TEST_TIMEOUT || 2000\n\n      global.mocha = new Mocha({ reporter: 'json', timeout: global.CASE_TEST_TIMEOUT })\n      mocha.ui('bdd')\n      mocha.suite.emit('pre-require', global, null, mocha);\n      setTimeout(function() {\n        // 记录测试用例\n        typeof fnTestCase === 'function' && fnTestCase(this)\n        var mochaRunner = mocha.run(function () {\n          if (mochaRunner) {\n            // 标题\n            mochaRunner.testResults.stats.title = mocha.suite.suites && mocha.suite.suites[0] && mocha.suite.suites[0].title\n            console.info('testResults: ', JSON.stringify(mochaRunner.testResults))\n            pushData('pageTestList', mochaRunner.testResults)\n\n            // 显示结果\n            const stats = mochaRunner.testResults.stats\n            this.$page.setTitleBar({ text: `通过/全部: ${stats.passes}/${stats.tests}` })\n          }\n\n          // 是否返回\n          if (this.back !== 'false') {\n            console.info('拥有关联测试用例，测试完毕，返回到之前的页面')\n            history.back()\n          }\n        }.bind(this))\n      }.bind(this), global.CASE_TEST_START)\n    },"),_utils.colorconsole.info("[INFO] 脚本注入测试用例："+c)}else i=i.replace("export default {","export default {\n    onCreate () {\n      // 允许back被外部覆盖\n      if (this._options._descriptor) {\n        this._options._descriptor['back'] = {access: 'public'}\n      }\n\n      // 测试执行：开始时间，结束事件\n      global.CASE_TEST_START = global.CASE_TEST_START || 1000\n      global.CASE_TEST_TIMEOUT = global.CASE_TEST_TIMEOUT || 2000\n\n      setTimeout(function() {\n        // 是否返回\n        if (this.back !== 'false') {\n          console.info('没有关联测试用例，直接返回到之前的页面')\n          history.back()\n        }\n      }.bind(this), global.CASE_TEST_START)\n    },")}var _=void 0;if(n.sourceMap&&(r===_utils.FRAG_TYPE.SCRIPT||r===_utils.FRAG_TYPE.IMPORT)){var T=s.location.line,f=void 0;t&&(f=(0,_utils.consumeMap)(n,e,t),e=f.sourcesContent.join(""));var p=(0,_utils.splitSourceLine)(i).map(function(e,t){t+=1;var n=t+T,s=t;return f&&(n=f.mapping["line-"+n+"-column-0"].line),{original:{line:n,column:0},generated:{line:s,column:0}}});_=(0,_utils.generateMap)(n,e,p)}return[i,_]}).then(function(e){var n=_slicedToArray(e,2),i=n[0],o=n[1];s(null,i,o&&o.toJSON()||t)}).catch(function(e){s(e,"")})};