"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ZipPlugin(e){this.options=e}function parse(e,i,t,r){i=i||".";var a=_path2.default.posix.join(e,i),o=void 0;r.readdirSync(a).forEach(function(n){var s=_path2.default.posix.join(a,n),p=r.statSync(s);if(p.isFile()){var u=i.split(_path2.default.sep).join(_path2.default.posix.sep);o=_path2.default.posix.join(u,_path2.default.basename(n)),t(o,s)}else if(p.isDirectory()){var l=_path2.default.posix.join(i,n);parse(e,l,t,r)}})}function removeWebpackCode(e,i){return/\.js$/.test(e)?(/app\.js$/.test(e)&&(i=i.replace(/\n\W__webpack_require__\(\d+\);\n/,"\n")),i):i}var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_jszip=require("jszip"),_jszip2=_interopRequireDefault(_jszip),_moment=require("moment"),_moment2=_interopRequireDefault(_moment),_sign=require("../../common/sign"),_sign2=_interopRequireDefault(_sign),_utils=require("../../common/utils"),projDir=process.cwd(),SignFileConfig={debug:{privatekey:_path2.default.join(projDir,"sign/debug/private.pem"),certificate:_path2.default.join(projDir,"sign/debug/certificate.pem")},release:{privatekey:_path2.default.join(projDir,"sign/release/private.pem"),certificate:_path2.default.join(projDir,"sign/release/certificate.pem")}};ZipPlugin.prototype.apply=function(e){var i=this.options,t=e.options,r=!t.watch,a=SignFileConfig[i.sign],o=i.pathBuild;e.plugin("after-emit",function(e,n){var s=this.outputFileSystem;if(!a)return void _utils.colorconsole.log("### App Loader ### 无签名配置项, 放弃打包: "+i.sign);if(a&&!_fs2.default.existsSync(a.privatekey))return void _utils.colorconsole.log("### App Loader ### 缺少私钥文件, 打包失败: "+a.privatekey);if(a&&!_fs2.default.existsSync(a.certificate))return void _utils.colorconsole.log("### App Loader ### 缺少证书文件, 打包失败: "+a.certificate);s.mkdirp(i.output);var p=[],u=new _jszip2.default,l=_fs2.default;t.devServer?(parse(o,".",function(e,i){var t=removeWebpackCode(i,s.readFileSync(i).toString());void 0!==t&&(p.push({name:Buffer.from(e),hash:_sign2.default.hashFile(t)}),u.file(e,t))},s),parse(o,".",function(e,i){var t=l.readFileSync(i);p.push({name:Buffer.from(e),hash:_sign2.default.hashFile(t)}),u.file(e,t)},l)):parse(o,".",function(e,i){var t=l.readFileSync(i);p.push({name:Buffer.from(e),hash:_sign2.default.hashFile(t)}),u.file(e,t)},l),u.generateAsync({type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}}).then(function(e){var t=i.name+"."+i.sign+".rpk",o=_path2.default.join(i.output,t);_utils.colorconsole.log("### App Loader ### dist目录签名并生成rpk文件："+t);var s=_fs2.default.readFileSync(a.privatekey),u=_fs2.default.readFileSync(a.certificate),f=_sign2.default.signZip({content:e,files:p},s,u);if(l.writeFileSync(o,f),r){var c=(0,_moment2.default)().format("YYYYMMDDhhmmss"),_=i.name+"_"+i.sign+"_"+i.versionCode+"_"+c+".rpk",d=_path2.default.join(i.output,_);l.writeFileSync(d,l.readFileSync(o)),_utils.colorconsole.log("### App Loader ### 复制rpk文件("+t+")为文件("+_+")")}n()})})},module.exports=ZipPlugin;