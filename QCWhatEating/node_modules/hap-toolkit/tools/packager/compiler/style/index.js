"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function processImport(e,t,s,a){var r=e,o=e.match(/@import\s+((?:['"]([^()]+?)['"])|(?:(?:url\(([^()]+?)\))))\s*;/g);return o&&o.length>0&&(t?o.forEach(function(e){var o=e.match(/(?:['"]([^()]+?)['"])|(?:(?:url\(([^()]+?)\)))/);if(o.length>1){var i=_path2.default.resolve(t,o[1]||o[2]),n=_fs2.default.readFileSync(i);if(n){var l=_path2.default.dirname(i);r=r.replace(e,"\n"+processImport(n.toString(),l,s,a)+"\n"),a.push(i)}else s.push({line:1,column:1,reason:"ERROR: 找不到文件 `"+e+"` , 导入失败"})}}):s.push({line:1,column:1,reason:"ERROR: 找不到资源路径, 无法处理@import"})),r}function parse(e,t){var s=void 0,a={},r=[],o=e.code||"",i=e.filePath,n=_path2.default.dirname(i),l=[];o=processImport(o,n,r,l);var u=_css2.default.parse(o,{silent:!0});u.stylesheet.parsingErrors&&u.stylesheet.parsingErrors.length&&(s=u.stylesheet.parsingErrors,s.forEach(function(e){r.push({line:e.line,column:e.column,reason:e.toString()})})),u&&"stylesheet"===u.type&&u.stylesheet&&u.stylesheet.rules&&u.stylesheet.rules.length&&u.stylesheet.rules.forEach(function(e){var t=e.type,s={};if("rule"===t){if(e.declarations&&e.declarations.length){e.declarations.forEach(function(e){if("declaration"===e.type){var t=e.property,a=e.value,o=(0,_utils.hyphenedToCamelCase)(t),n=(0,_validator.validate)(o,a,{filePath:i});n.value.forEach(function(e){(0,_utils.isValidValue)(e.v)&&(s[e.n]=e.v)}),n.log&&r.push({line:e.position.start.line,column:e.position.start.column,reason:n.log.reason})}});var o=/^[.#]?[A-Za-z0-9_\-:]+$/,n=/^([.#]?[A-Za-z0-9_-]+(\s+|\s*>\s*))+([.#]?[A-Za-z0-9_\-:]+)$/;e.selectors.forEach(function(t){var i={key:t,val:s};if(t.match(o)||t.match(n)){if(!processPseudoClass(i,r,e))return;if(a[i.key]&&t===i.key&&!(0,_utils.equals)(a[i.key],i.val,cssCompare)&&r.push({line:e.position.start.line,column:e.position.start.column,reason:"WARN: 选择器 `"+i.key+"` 已经存在，后者合并前者"}),!_config.options.optimizeDescMeta&&t.match(n))try{i.val=Object.assign({},i.val),i.val._meta={},i.val._meta.ruleDef=(0,_compress.compressDescSelector)((0,_cssWhat2.default)(i.key))}catch(t){return void r.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 选择器 `"+i.key+"` 不支持"})}a[i.key]=(0,_utils.extend)({},a[i.key]||{},i.val)}else r.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 选择器 `"+t+"` 非法"})})}}else if("font-face"===t)e.declarations&&e.declarations.length&&(e.declarations.forEach(function(e){if("declaration"===e.type){var t=(0,_utils.hyphenedToCamelCase)(e.property),a=e.value;"fontFamily"===t&&"'".indexOf(a[0])>-1&&(a=a.slice(1,a.length-1)),s[t]=a}}),a["@FONT-FACE"]||(a["@FONT-FACE"]=[]),a["@FONT-FACE"].push(s));else if("keyframes"===t&&e.keyframes&&e.keyframes.length){var l=e.name,u=[];e.keyframes.forEach(function(t){var s=void 0;if("keyframe"===t.type&&t.declarations&&t.declarations.length)if(s={},t.declarations.forEach(function(e){if("declaration"===e.type){var t=e.property,a=e.value,o=(0,_utils.hyphenedToCamelCase)(t),i=(0,_validator.validate)(o,a);i.value.forEach(function(e){(0,_utils.isValidValue)(e.v)&&(s[e.n]=e.v)}),i.log&&r.push({line:e.position.start.line,column:e.position.start.column,reason:i.log.reason})}}),(0,_utils.isEmptyObject)(s))r.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 动画 `"+l+"` 的关键帧 `"+JSON.stringify(t.values)+"` 没有有效的属性"});else{var a=void 0;t.values.forEach(function(e){a="from"===e?0:"to"===e?100:parseFloat(e.replace("%","")),s.time=a,u.push(s)})}}),u.sort(function(e,t){return e.time-t.time}),a["@KEYFRAMES"]||(a["@KEYFRAMES"]={}),a["@KEYFRAMES"][l]=u}}),_config.options.optimizeCssAttr&&(0,_compress.compressCssAttr)(a),t(s,{jsonStyle:a,depList:l,log:r})}function processPseudoClass(e,t,s){var a=e.key.indexOf(":");if(a>-1){var r=e.key.slice(a);if(!(0,_validator.validatePseudoClass)(r))return t.push({line:s.position.start.line,column:s.position.start.column,reason:"ERROR: 不支持伪类选择器`"+r+"`"}),!1;e.key=e.key.slice(0,a);var o={};Object.keys(e.val).forEach(function(t){o[t+r]=e.val[t]}),e.val=o}return!0}function cssCompare(e,t,s){if("_meta"===s)return!0}var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_css=require("css"),_css2=_interopRequireDefault(_css),_cssWhat=require("css-what"),_cssWhat2=_interopRequireDefault(_cssWhat),_validator=require("./validator"),_compress=require("./compress"),_config=require("../../common/config"),_utils=require("../../common/utils");module.exports={parse:parse,validateDelaration:_validator.validate};