"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(o,a){try{var i=r[o](a),s=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}return n("next")})}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.logger=void 0;var index=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.app.server.address().port,o=(0,_service.getServerAddress)(n),a=_qrImage2.default.image(o,{size:9}),r.type="image/png",r.body=a,e.next=7,t();case 7:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),bundle=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a,i,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=process.cwd(),o=(0,_service.getProjectName)(),a=_path2.default.join(n,"dist"),i=_path2.default.join(a,o+".debug.rpk"),s=_path2.default.join(a,o+".release.rpk"),_fs2.default.existsSync(i)?(r.body=_fs2.default.createReadStream(i),r.set("Content-Type","text/plain")):_fs2.default.existsSync(s)?(r.body=_fs2.default.createReadStream(s),r.set("Content-Type","text/plain")):(_utils.colorconsole.error("### App Server ### 项目dist目录下不存在rpk文件："+a),r.throw("404","无法找到项目的rpk文件")),e.next=8,t();case 8:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),logger=exports.logger=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a,i,s,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=r.conf.defaults.pathClientLog,o=(0,_service.getClientFromRequest)(r.request),a=o.sn,i=o.clientIp,s=o.linkMode,u={sn:a,ip:i,port:CLIENT_PORT},e.t0=s,e.next=e.t0===_service.LINK_MODE.WIFI?7:e.t0===_service.LINK_MODE.ADB?10:13;break;case 7:return _utils.colorconsole.info("### App Server ### 记录从"+i+"进入的HTTP请求"),(0,_service.recordClient)(n,u),e.abrupt("break",13);case 10:return u=(0,_service.getRecordClient)(n,a,i),u?(_utils.colorconsole.info("### App Server ### 记录从设备("+a+")进入的HTTP请求"),(0,_service.recordClient)(n,u)):_utils.colorconsole.warn("### App Server ### ：记录设备("+a+")失败"),e.abrupt("break",13);case 13:return e.next=15,t();case 15:e.next=20;break;case 17:e.prev=17,e.t1=e.catch(0),_utils.colorconsole.error("### App Server ### 记录log出错: "+e.t1.message);case 20:case"end":return e.stop()}},e,this,[[0,17]])}));return function(r,t){return e.apply(this,arguments)}}(),qrCode=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.app.server.address().port,o=(0,_service.getServerAddress)(n),a=_qrImage2.default.image(o,{size:9}),e.next=5,t();case 5:r.type="image/png",r.body=a;case 7:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_qrImage=require("qr-image"),_qrImage2=_interopRequireDefault(_qrImage),_service=require("../service"),_utils=require("../lib/utils"),CLIENT_PORT=39517;exports.default={index:index,bundle:bundle,qrCode:qrCode,logger:logger};