"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function signZip(e,t,n){var r=Buffer.from(_base2.default.unarmor(n)),i=new _jsrsasign2.default.X509;i.readCertPEM(n.toString());var a=_jsrsasign2.default.KEYUTIL.getPEM(i.subjectPublicKeyRSA),s=e.content;if(!s||s.length<=4)return _utils.colorconsole.error("### App Loader ### Zip文件打开失败"),!1;if("4034b50"!==s.readInt32LE(0).toString(16).toLowerCase())return _utils.colorconsole.error("### App Loader ### Zip文件格式错误"),!1;var l=parserZip(s);if(l.options=e,l.tag){Object.keys(l.sections).forEach(function(e){var n=l.sections[e];processChunk(s,n,t)}),signChunk(l,t,a,r);return saveChunk(s,l)}return null}function parserZip(e){var t={tag:!1,length:e.length,sections:{header:null,central:null,footer:null}};return t.sections.footer=readEOCD(e),t.sections.footer.tag&&(t.sections.central=readCD(e,t.sections.footer.previous,t.sections.footer.startIndex-t.sections.footer.previous),t.sections.central.tag&&(t.sections.header=readFH(e,t.sections.central.previous,t.sections.central.startIndex-t.sections.central.previous),t.sections.header.tag&&(t.tag=!0))),t}function readEOCD(e){var t={tag:!1};if(e&&e.length>=22)for(var n=e.length-22,r=void 0;n>=0;){if(r=e.readInt32LE(n),"6054b50"===r.toString(16).toLowerCase()){t.tag=!0,t.startIndex=n,t.len=e.length-n,t.previous=e.readInt32LE(n+16);break}n-=1}return t}function readCD(e,t,n){var r={tag:!1};if(e&&e.length>=t){"2014b50"===e.readInt32LE(t).toString(16).toLowerCase()&&(r.tag=!0,r.startIndex=t,r.len=n,r.previous=e.readInt32LE(t+42))}return r}function readFH(e,t,n){var r={tag:!1};if(e&&e.length>=t){"4034b50"===e.readInt32LE(t).toString(16).toLowerCase()&&(r.tag=!0,r.startIndex=t,r.len=n,r.previous=-1)}return r}function processChunk(e,t,n){var r=t.startIndex,i=t.startIndex+t.len,a=e.slice(r,i),s=Buffer.alloc(5+t.len);s[0]=165,s.writeInt32LE(a.length,1),a.copy(s,5);var l=_crypto2.default.createHash("SHA256");l.update(s),t.sign=l.digest()}function hashFile(e){var t=_crypto2.default.createHash("SHA256");return t.update(e),t.digest()}function signChunk(e,t,n,r){function i(e){e.copy(l,o),o+=e.length}var a=e.sections,s=a.header.sign.length+a.central.sign.length+a.footer.sign.length+5,l=Buffer.alloc(s),o=0;l.writeInt8(90,0),l.writeInt32LE(3,1),o+=5,i(a.header.sign),i(a.central.sign),i(a.footer.sign);var u=_crypto2.default.createHash("SHA256");u.update(l);var g=u.digest(),c=makeSignChunk(e.options,g,t,n,r);e.signchunk=saveSignChunk(c)}function makeSignChunk(e,t,n,r,i){var a=Buffer.alloc(t.length+12);a.writeInt32LE(t.length+8,0),a.writeInt32LE(259,4),a.writeInt32LE(t.length,8),t.copy(a,12);var s={len:a.length,buffer:a},l=Buffer.alloc(i.length+4);l.writeInt32LE(i.length,0),i.copy(l,4);var o={len:l.length,buffer:l},u={len:12,digests:{size:0,data:[]},certs:{size:0,data:[]},additional:0};u.digests.data.push(s),u.digests.size+=s.len,u.len+=s.len,u.certs.data.push(o),u.certs.size+=o.len,u.len+=o.len;var g=Buffer.from(_base2.default.unarmor(r)),c={len:16+g.length,size:12+g.length,signdata:{size:0,buffer:null},signatures:{size:0,data:[]},pubkey:{size:g.length,buffer:g}};c.signdata.buffer=makeSignDataBuffer(u),c.signdata.size=u.len,c.size+=u.len,c.len+=u.len;var f=_crypto2.default.createSign("RSA-SHA256");f.update(c.signdata.buffer);var d=f.sign(n),h={len:d.length+12,size:d.length+8,id:259,buffer:d};c.signatures.data.push(h),c.signatures.size+=h.len,c.size+=h.len,c.len+=h.len;var p={len:4,size:0,data:[]};p.data.push(c),p.size+=c.len,p.len+=c.len;var v={len:p.len+12,size:p.len+4,id:16777473,value:p},I={len:32,size:24,data:[]};if(I.data.push(v),I.size+=v.len,I.len+=v.len,e.files){var E=signFiles(e.files,n);if(E){var L={len:4,size:0,data:[]};L.data.push(E),L.size+=E.length,L.len+=E.length;var z={len:L.len+12,size:L.len+4,id:16777729,value:L};I.data.push(z),I.size+=z.len,I.len+=z.len}}return I}function makeSignDataBuffer(e){var t=Buffer.alloc(e.len),n=0;return t.writeInt32LE(e.digests.size,n),n+=4,e.digests.data.forEach(function(e){e.buffer.copy(t,n),n+=e.len}),t.writeInt32LE(e.certs.size,n),n+=4,e.certs.data.forEach(function(e){e.buffer.copy(t,n),n+=e.len}),t.writeInt32LE(e.additional,n),t}function saveSignChunk(e){var t=Buffer.alloc(e.len),n=0;return t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(0,n),n+=4,e.data.forEach(function(e){t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(0,n),n+=4,t.writeInt32LE(e.id,n),n+=4,t.writeInt32LE(e.value.size,n),n+=4,16777473===e.id?e.value.data.forEach(function(e){t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(e.signdata.size,n),n+=4,e.signdata.buffer.copy(t,n),n+=e.signdata.buffer.length,t.writeInt32LE(e.signatures.size,n),n+=4,e.signatures.data.forEach(function(e){t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(e.id,n),n+=4,t.writeInt32LE(e.buffer.length,n),n+=4,e.buffer.copy(t,n),n+=e.buffer.length}),t.writeInt32LE(e.pubkey.size,n),n+=4,e.pubkey.buffer.copy(t,n),n+=e.pubkey.buffer.length}):16777729===e.id&&e.value.data.forEach(function(e){e.copy(t,n),n+=e.length})}),t.writeInt32LE(e.size,n),n+=4,t.writeInt32LE(0,n),n+=4,Buffer.from(SigMagic).copy(t,n),t}function saveChunk(e,t){var n=Buffer.alloc(e.length+t.signchunk.length),r=0,i=t.sections;return e.copy(n,r,i.header.startIndex,i.header.startIndex+i.header.len),r+=i.header.len,t.signchunk.copy(n,r),r+=t.signchunk.length,e.copy(n,r,i.central.startIndex,i.central.startIndex+i.central.len),r+=i.central.len,e.writeInt32LE(i.central.startIndex+t.signchunk.length,i.footer.startIndex+16),e.copy(n,r,i.footer.startIndex,i.footer.startIndex+i.footer.len),r+=i.footer.len,n}function signFiles(e,t){var n={len:8,size:4,digests:[],sign:null};return e.forEach(function(e){var t=_crc2.default.digest(e.name.toString()),r=6+e.hash.length,i=Buffer.alloc(r),a=0;i.writeInt32LE(t,a),a+=4,i.writeInt16LE(e.hash.length,a),a+=2,e.hash.copy(i,a),a+=e.hash.length,n.digests.push(i),n.size+=r,n.len+=r}),signDigestChunk(n,t),saveDigestChunk(n)}function signDigestChunk(e,t){var n=Buffer.alloc(e.size),r=0;n.writeInt32LE(259,r),r+=4,e.digests.forEach(function(e){e.copy(n,r),r+=e.length}),e.digests=n.slice();var i=_crypto2.default.createSign("RSA-SHA256");i.update(n);var a=i.sign(t);e.sign={len:12+a.length,size:8+a.length,id:259,data:a},e.len+=e.sign.len}function saveDigestChunk(e){var t=Buffer.alloc(e.len),n=0;return t.writeInt32LE(e.size,n),n+=4,e.digests.copy(t,n),n+=e.digests.length,t.writeInt32LE(e.sign.size,n),n+=4,t.writeInt32LE(e.sign.id,n),n+=4,t.writeInt32LE(e.sign.data.length,n),n+=4,e.sign.data.copy(t,n),n+=e.sign.data.length,t}var _crypto=require("crypto"),_crypto2=_interopRequireDefault(_crypto),_jsrsasign=require("jsrsasign"),_jsrsasign2=_interopRequireDefault(_jsrsasign),_base=require("./base64"),_base2=_interopRequireDefault(_base),_crc=require("./crc32"),_crc2=_interopRequireDefault(_crc),_utils=require("../utils"),SigMagic="RPK Sig Block 42";module.exports={signZip:signZip,hashFile:hashFile};