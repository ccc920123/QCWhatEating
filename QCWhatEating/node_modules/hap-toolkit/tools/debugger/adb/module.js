"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(i,o){try{var a=r[i](o),s=a.value}catch(e){return void t(e)}if(!a.done)return Promise.resolve(s).then(function(e){n("next",e)},function(e){n("throw",e)});e(s)}return n("next")})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_utils=require("../lib/utils"),_debuglog=require("./debuglog"),_debuglog2=_interopRequireDefault(_debuglog),_deviceEmitter=require("./deviceEmitter"),_deviceEmitter2=_interopRequireDefault(_deviceEmitter),_commander2=require("./commander"),_commander3=_interopRequireDefault(_commander2),REMOTE_REVERSE_PORT=12306,REMOTE_UP_FORWARD_PORT=39517,ADBModule=function(){function e(r){_classCallCheck(this,e),this.option=r,this.currentDeviceMap=new Map,this.cachedDeviceMap=new Map,this.DEBUG=(process.env.NODE_DEBUG||"").split(",").includes("adb"),this._localUpForwardPort=REMOTE_UP_FORWARD_PORT,this.commander=new _commander3.default,this.emitter=new _deviceEmitter2.default,this._lastPromise=null,this.init()}return _createClass(e,[{key:"init",value:function(){var e=this;(0,_debuglog2.default)("init(): start"),this.emitter.addEventListener("deviceAdded",function(r){e._listen(r,e.onDeviceAdded.bind(e))}),this.emitter.addEventListener("deviceRemoved",function(r){e._listen(r,e.onDeviceRemoved.bind(e))}),this.emitter.start()}},{key:"_listen",value:function(e,r){this._lastPromise?this._lastPromise=this._lastPromise.then(function(){return r(e)},function(){return r(e)}):this._lastPromise=r(e)}},{key:"_getNextLocalForwardPort",value:function(){return this._localUpForwardPort++}},{key:"onDeviceAdded",value:function(){function e(e){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,i,o,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.sn,_utils.colorconsole.info("### App Server ### 手机设备("+t+")被连入"),n=this.option.localReversePort,e.next=5,this.establishADBProxyLink("reverse",[t,n,REMOTE_REVERSE_PORT]);case 5:if(i=e.sent,!i.err){e.next=9;break}return _utils.colorconsole.error("### App Server ### onDeviceAdded(): ("+t+")建立adb reverse失败(local port: "+n+", remote port: "+REMOTE_REVERSE_PORT+")"),e.abrupt("return");case 9:return o=this.cachedDeviceMap.get(t),(0,_debuglog2.default)("onDeviceAdded():("+t+")\ncachedDevice:\t"+JSON.stringify(o)+"\ncachedDeviceList:\t"+JSON.stringify(Array.from(this.cachedDeviceMap.entries()))),o&&o.upForwardPortPair||(o={upForwardPortPair:[this._getNextLocalForwardPort(),REMOTE_UP_FORWARD_PORT]}),e.next=14,this.establishADBProxyLink("forward",[t].concat(o.upForwardPortPair));case 14:if(a=e.sent,!a.err){e.next=18;break}return _utils.colorconsole.error("### App Server ### onDeviceAdded(): ("+t+")建立adb forward失败(local port: "+o.upForwardPortPair[0]+", remote port: "+o.upForwardPortPair[1]+") "),e.abrupt("return");case 18:if(!o.wsPortPair){e.next=23;break}return e.next=21,this.establishADBProxyLink("forward",[t,o.wsPortPair[0],o.wsPortPair[1]]);case 21:s=e.sent,s.err&&(_utils.colorconsole.warn("### App Server ### onDeviceAdded():("+t+") 建立adb forward失败(local port: "+o.wsPortPair[0]+", remote port: "+o.wsPortPair[1]+")"),o.wsPortPair=void 0);case 23:return this.currentDeviceMap.set(t,o),this.cachedDeviceMap.set(t,o),e.next=27,this._writeClientLogFile({sn:t,ip:"127.0.0.1",port:o.upForwardPortPair[0]});case 27:(0,_debuglog2.default)("onDeviceAdded():("+t+") end");case 28:case"end":return e.stop()}},e,this)}));return e}()},{key:"onDeviceRemoved",value:function(){function e(e){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.sn,_utils.colorconsole.info("### App Server ### 手机设备("+t+")被拔出"),this.currentDeviceMap.delete(t),!this.DEBUG){e.next=9;break}return(0,_debuglog2.default)("deviceRemoved():("+t+") cachedDeviceList: "+JSON.stringify(Array.from(this.cachedDeviceMap.entries()))),e.next=7,this.commander.print("adb -s "+t+" reverse --list");case 7:return e.next=9,this.commander.print("adb -s "+t+" forward --list");case 9:return e.next=11,this._removeItemFromClientLogFile(t);case 11:(0,_debuglog2.default)("deviceRemoved():("+t+") end");case 12:case"end":return e.stop()}},e,this)}));return e}()},{key:"_writeClientLogFile",value:function(){function e(e){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{for(t=this.option.pathClientLog,n=_path2.default.dirname(t),(0,_utils.mkdirsSync)(n),i=void 0,i=_fs2.default.existsSync(t)?JSON.parse(_fs2.default.readFileSync(t)).clients:[],(0,_debuglog2.default)("writeClientLogFile(): before: "+JSON.stringify(i)),i=i.filter(function(e){return e.ip!==r.ip||r.port!==r.port});i.length>4;)i.shift();i.push(r),o={clients:i},_fs2.default.writeFileSync(t,JSON.stringify(o,null,2)),(0,_debuglog2.default)("writeClientLogFile(): after: "+JSON.stringify(i))}catch(e){_utils.colorconsole.error("### App Server ### writeClientLogFile(): 写入client.json文件出错: "+e.message)}case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"_removeItemFromClientLogFile",value:function(){function e(e){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{t=this.option.pathClientLog,n=JSON.parse(_fs2.default.readFileSync(t)).clients,(0,_debuglog2.default)("_removeItemFromClientLogFile(): before: "+JSON.stringify(n)),n=n.filter(function(e){return e.sn!==r}),i={clients:n},_fs2.default.writeFileSync(t,JSON.stringify(i,null,2)),(0,_debuglog2.default)("_removeItemFromClientLogFile(): after: "+JSON.stringify(n))}catch(e){_utils.colorconsole.error("### App Server ### _removeItemFromClientLogFile(): 移除client.json设备信息出错： "+e.message)}case 1:case"end":return e.stop()}},e,this)}));return e}()},{key:"forwardForWsChannel",value:function(){function e(e,t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,i,o,a,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.currentDeviceMap.get(r)){e.next=4;break}return _utils.colorconsole.error("### AppApp Server ### 获取("+r+")设备信息失败"),e.abrupt("return");case 4:if(i=n.wsPortPair,o=t,!i||i[0]!==o||i[1]!==t){e.next=8;break}return e.abrupt("return",{localWsPort:o});case 8:return e.next=10,this.establishADBProxyLink("forward",[r,o,t]);case 10:if(a=e.sent,!(s=a.err)){e.next=16;break}return _utils.colorconsole.error("### AppApp Server ### forwardForWsChannel(): 创建WebSocket端口映射失败"),n.wsPortPair=void 0,e.abrupt("return",{err:s});case 16:return n.wsPortPair=[o,t],e.abrupt("return",{localWsPort:o});case 18:case"end":return e.stop()}},e,this)}));return e}()},{key:"establishADBProxyLink",value:function(){function e(e,t){return r.apply(this,arguments)}var r=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(n=this.commander)[r].apply(n,_toConsumableArray(t));case 2:if(i=e.sent,!this.DEBUG){e.next=7;break}return(0,_debuglog2.default)("establishADBReverseLink(): ("+t[0]+") adb "+r+" setup result: "+JSON.stringify(i)),e.next=7,this.commander.print("adb -s "+t[0]+" "+r+" --list");case 7:return e.abrupt("return",i);case 8:case"end":return e.stop()}},e,this)}));return e}()}]),e}();exports.default=ADBModule;