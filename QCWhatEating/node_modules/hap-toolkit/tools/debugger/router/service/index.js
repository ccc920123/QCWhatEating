"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(o,s){try{var i=r[o](s),u=i.value}catch(e){return void t(e)}if(!i.done)return Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)});e(u)}return n("next")})}}function getInspectorUrl(e){var r=e.ws,t=e.serverPort;return"http://"+(0,_utils.getServerIPAndPort)(t)+"/inspector/inspector.html?ws="+encodeURI(r)+"&remoteFrontend=true&dockSide=undocked"}function untarInspectorTarFile(e){var r=e.inspectorTarFile,t=e.inspectorHtmlDir,n=!_fs2.default.existsSync(t),o=_fs2.default.existsSync(r);if(n)if(o&&n)_tar2.default.x({file:r,cwd:_path2.default.dirname(r)});else if(!o)throw new Error("缺少devtools inspector工程文件夹")}function routerConf(e){return e.router.conf}function serverConf(e){return e.conf}function getClientFromRequest(e){var r=(0,_utils.getClientIPAddress)(e),t=(0,_utils.getIPv4IPAddress)(),n=e.header["device-serial-number"],o=LINK_MODE.NULL;return"127.0.0.1"===r&&n?o=LINK_MODE.ADB:"127.0.0.1"!==r&&r!==t&&(o=LINK_MODE.WIFI),{clientIp:r,sn:n,linkMode:o}}function getDebugInfoFromRequest(e){var r=getClientFromRequest(e),t=r.sn,n=r.linkMode,o=e.body,s=o.ws;return{sn:t,linkMode:n,ws:s,application:o.application,devicePort:s.split(":")[1].split("/")[0]}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.prepareStartServer=exports.LINK_MODE=void 0;var prepareStartServer=exports.prepareStartServer=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=routerConf(r.context),e.next=4,untarInspectorTarFile(t);case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 解压inspector.tar.gz文件出错: "+e.t0.message);case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(r){return e.apply(this,arguments)}}();exports.getInspectorUrl=getInspectorUrl,exports.untarInspectorTarFile=untarInspectorTarFile,exports.routerConf=routerConf,exports.serverConf=serverConf,exports.getDebugInfoFromRequest=getDebugInfoFromRequest;var _path=require("path"),_path2=_interopRequireDefault(_path),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_tar=require("tar"),_tar2=_interopRequireDefault(_tar),_utils=require("../../lib/utils"),LINK_MODE=exports.LINK_MODE={NULL:0,WIFI:1,ADB:2};