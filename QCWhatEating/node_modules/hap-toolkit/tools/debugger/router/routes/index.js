"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function n(o,a){try{var s=r[o](a),i=s.value}catch(e){return void t(e)}if(!s.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});e(i)}return n("next")})}}function emitWSEvent(e,r,t){e.sockets.emit(r,t||{})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.startDebug=exports.redirectHtmlReq=void 0;var index=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(0,_service.routerConf)(r),o=n.htmlPageDir,a=_path3.default.join(o,"index.html"),e.prev=2,!_fs2.default.existsSync(a)){e.next=8;break}r.set("Content-Type","text/html"),r.body=_fs2.default.createReadStream(a),e.next=11;break;case 8:return e.next=10,t();case 10:r.throw("404","无法找到"+a+"文件");case 11:e.next=17;break;case 13:e.prev=13,e.t0=e.catch(2),_utils.colorconsole.error("### App Server ### 无法获取"+a+"文件: "+e.t0),r.body="404 Not found "+a;case 17:return e.abrupt("return");case 18:case"end":return e.stop()}},e,this,[[2,13]])}));return function(r,t){return e.apply(this,arguments)}}(),register=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _utils.colorconsole.info("### App Server ### 收到App注册信息, 格式:\n"+JSON.stringify(r.request.body)+"\n"),e.next=3,t();case 3:n=r.request.body,o=n.ws,a=n.application,s=(0,_service.serverConf)(r).defaults.serverPort,i=(0,_service.getInspectorUrl)({ws:o,serverPort:s}),emitWSEvent(r.io,"appRegistered",{inspectorUrl:i,application:a}),_utils.colorconsole.info("请访问以下链接进行调试：\n\n"+i+"\n");case 8:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),adapterForBackwardComp=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a,s,i,u,c,p,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=r.request.body,o=r.method,a=r.path,s="ws"in n&&n.ws.indexOf("inspector")>=0,i="application"in n&&n.application.indexOf("hybrid.loader")>=0,"post"!==o.toLowerCase()||"/"!==a||!s||!i){e.next=15;break}_utils.colorconsole.warn("调试器已有重要更新，请更新调试器"),emitWSEvent(r.io,"informUpdate"),u=n.ws,c=n.application,p=(0,_service.serverConf)(r).defaults.serverPort,l=(0,_service.getInspectorUrl)({ws:u,serverPort:p}),emitWSEvent(r.io,"appRegistered",{inspectorUrl:l,application:c}),_utils.colorconsole.info("请访问以下链接进行调试：\n\n"+l+"\n"),e.next=17;break;case 15:return e.next=17,t();case 17:e.next=25;break;case 19:return e.prev=19,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 出错信息: "+e.t0.message),_utils.colorconsole.error("### App Server ### 当前调试器与toolkit不兼容，请更新调试器。"),e.next=25,t();case 25:case"end":return e.stop()}},e,this,[[0,19]])}));return function(r,t){return e.apply(this,arguments)}}(),redirectHtmlReq=exports.redirectHtmlReq=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.req,o=_url2.default.parse(n.url),!/.*\.html?$/.test(o.pathname)||/^\/html/.test(o.pathname)){e.next=7;break}_utils.colorconsole.info("### App Server ### 重定向html文件请求"),r.redirect("/html"+o.path),e.next=9;break;case 7:return e.next=9,t();case 9:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),qrCode=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,_service.serverConf)(r).defaults.serverPort,o="http://"+(0,_utils.getServerIPAndPort)(n),a=_qrImage2.default.image(o,{size:9}),e.next=5,t();case 5:r.type="image/png",r.body=a;case 7:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),startDebug=exports.startDebug=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,a,s,i,u,c,p,l,f,v;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(0,_service.getDebugInfoFromRequest)(r.request),o=n.sn,a=n.linkMode,s=n.devicePort,i=n.application,u=n.ws,a!==_service.LINK_MODE.ADB){e.next=15;break}return e.next=6,r.adbDebugger.forwardForWsChannel(o,s);case 6:if(c=e.sent,p=c.localWsPort,!(l=c.err)){e.next=14;break}return console.error("startDebug(): adb forward 端口映射失败: "+l.message),e.next=13,t();case 13:return e.abrupt("return",e.sent);case 14:u=u.replace(s,p);case 15:return f=(0,_service.serverConf)(r).defaults.serverPort,v=(0,_service.getInspectorUrl)({ws:u,serverPort:f}),emitWSEvent(r.io,"appRegistered",{inspectorUrl:v,application:i}),_utils.colorconsole.info("请访问以下链接进行调试：\n\n"+v+"\n"),e.next=21,(0,_utils.startChrome)(v,{chromePath:(0,_service.serverConf)(r).options.chromePath});case 21:return e.next=23,t();case 23:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}(),_path2=require("path"),_path3=_interopRequireDefault(_path2),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_url=require("url"),_url2=_interopRequireDefault(_url),_qrImage=require("qr-image"),_qrImage2=_interopRequireDefault(_qrImage),_utils=require("../../lib/utils"),_service=require("../service");exports.default={index:index,register:register,adapterForBackwardComp:adapterForBackwardComp,redirectHtmlReq:redirectHtmlReq,qrCode:qrCode,startDebug:startDebug};